<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Appendices &#8212; Leo 6.8.6 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/classic.css?v=2bf1fcf8" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=a1d61795" />
    
    <script src="_static/documentation_options.js?v=452ccbb7"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="More Leo Links" href="toc-more-links.html" />
    <link rel="prev" title="Leo University" href="leo-university.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="toc-more-links.html" title="More Leo Links"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="leo-university.html" title="Leo University"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="leo_toc.html">Leo 6.8.6 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Appendices</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="appendices">
<h1>Appendices<a class="headerlink" href="#appendices" title="Link to this heading">¶</a></h1>
<nav class="contents local" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#format-of-leo-files" id="id2">Format of .leo files</a></p></li>
<li><p><a class="reference internal" href="#format-of-external-files" id="id3">Format of external files</a></p></li>
<li><p><a class="reference internal" href="#the-leonine-way-to-refactor-code" id="id4">The Leonine way to refactor code</a></p></li>
<li><p><a class="reference internal" href="#theory-of-operation-c-deletepositionsinlist" id="id5">Theory of operation: c.deletePositionsInList</a></p></li>
<li><p><a class="reference internal" href="#leo-s-colorizer-theory-of-operation" id="id6">Leo’s Colorizer: Theory of Operation</a></p>
<ul>
<li><p><a class="reference internal" href="#components-of-the-jedit-class" id="id7">Components of the jedit class</a></p></li>
<li><p><a class="reference internal" href="#the-big-challenge" id="id8">The big challenge</a></p></li>
<li><p><a class="reference internal" href="#about-states-and-restarters" id="id9">About states and restarters</a></p></li>
<li><p><a class="reference internal" href="#mode-files" id="id10">Mode files</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#leoast-py" id="id11">leoAst.py</a></p>
<ul>
<li><p><a class="reference internal" href="#running-leoast-py" id="id12">Running leoAst.py</a></p></li>
<li><p><a class="reference internal" href="#tokenorder-classes-theory-of-operation" id="id13">TokenOrder classes: Theory of operation</a></p></li>
<li><p><a class="reference internal" href="#maintaining-leoast-py" id="id14">Maintaining leoAst.py</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#unicode-reference" id="id15">Unicode reference</a></p></li>
<li><p><a class="reference internal" href="#valid-url-s" id="id16">Valid URL’s</a></p></li>
<li><p><a class="reference internal" href="#the-mulder-ream-update-algorithm" id="id17">The Mulder/Ream update algorithm</a></p>
<ul>
<li><p><a class="reference internal" href="#what-the-algorithm-does" id="id18">What the algorithm does</a></p></li>
<li><p><a class="reference internal" href="#guesses-don-t-matter" id="id19">Guesses don’t matter</a></p></li>
<li><p><a class="reference internal" href="#background-of-the-code" id="id20">Background of the code</a></p></li>
<li><p><a class="reference internal" href="#aha-the-x-sentinels-array" id="id21">Aha: the x.sentinels array</a></p></li>
<li><p><a class="reference internal" href="#strategy-proof-of-correctness" id="id22">Strategy &amp; proof of correctness</a></p></li>
<li><p><a class="reference internal" href="#summary" id="id23">Summary</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#why-i-like-python" id="id24">Why I like Python</a></p>
<ul>
<li><p><a class="reference internal" href="#clarity" id="id25">Clarity</a></p></li>
<li><p><a class="reference internal" href="#power" id="id26">Power</a></p></li>
<li><p><a class="reference internal" href="#safety" id="id27">Safety</a></p></li>
<li><p><a class="reference internal" href="#speed" id="id28">Speed</a></p></li>
<li><p><a class="reference internal" href="#conclusions" id="id29">Conclusions</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="format-of-leo-files">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Format of .leo files</a><a class="headerlink" href="#format-of-leo-files" title="Link to this heading">¶</a></h2>
<p>Here are the XML elements that may appear in Leo files:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">&lt;?xml&gt;</span></code></dt><dd><p>Leo files start with the following line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
</pre></div>
</div>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">&lt;?xml-stylesheet&gt;</span></code></dt><dd><p>This element is optional.  For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;?xml-stylesheet ekr_stylesheet?&gt;
</pre></div>
</div>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">&lt;leo_file&gt;</span></code></dt><dd><p>This element opens an element that contains the entire file.
<code class="docutils literal notranslate"><span class="pre">&lt;/leo_file&gt;</span></code> ends the file.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">&lt;leo_header&gt;</span></code></dt><dd><p>This element specifies version information and other information
that affects how Leo parses the file.  For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">leo_header</span> <span class="n">file_format</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="o">/&gt;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">file_format</span></code> attribute gives the ‘major’ format number.
It is <code class="docutils literal notranslate"><span class="pre">&quot;2&quot;</span></code> for all newer versions of Leo.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">&lt;globals&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;preferences&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;find_panel_settings&gt;</span></code> and``&lt;clone_windows&gt;``</dt><dd><p>These elements are vestigial. <br />
Modern versions of Leo ignore them when reading outlines and write
empty elements when writing outlines.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">&lt;vnodes&gt;</span></code></dt><dd><p>A single <code class="docutils literal notranslate"><span class="pre">&lt;vnodes&gt;</span></code> element contains nested <code class="docutils literal notranslate"><span class="pre">&lt;v&gt;</span></code> elements.
<code class="docutils literal notranslate"><span class="pre">&lt;v&gt;</span></code> elements correspond to vnodes.
The nesting of <code class="docutils literal notranslate"><span class="pre">&lt;v&gt;</span></code> elements indicates outline structure in the obvious way.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">&lt;v&gt;</span></code></dt><dd><p>This element represents a single vnode and has the following form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">v</span><span class="o">...&gt;&lt;</span><span class="n">vh</span><span class="o">&gt;</span><span class="n">sss</span><span class="o">&lt;/</span><span class="n">vh</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">zero</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">nested</span> <span class="n">v</span> <span class="n">elements</span><span class="p">)</span> <span class="o">&lt;/</span><span class="n">v</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">&lt;vh&gt;</span></code> element specifies the headline text.
sss is the headline text encoded with the usual XML escapes.
As shown above, a <code class="docutils literal notranslate"><span class="pre">&lt;v&gt;</span></code> element may contain nested <code class="docutils literal notranslate"><span class="pre">&lt;v&gt;</span></code> elements.
Zero or more of the following attributes may appear in &lt;v&gt; elements:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">t</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">n</span>
<span class="n">a</span><span class="o">=</span><span class="s2">&quot;xxx&quot;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">t=&quot;Tnnn&quot;</span></code> attribute specifies the &lt;t&gt; element associated with a &lt;v&gt; element.
The <code class="docutils literal notranslate"><span class="pre">a=&quot;xxx&quot;</span></code> attribute specifies vnode attributes.
<code class="docutils literal notranslate"><span class="pre">xxx</span></code> denotes one or more upper-case letters whose meanings are as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">C</span>       <span class="n">The</span> <span class="n">vnode</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">clone</span><span class="o">.</span> <span class="p">(</span><span class="n">Not</span> <span class="n">used</span> <span class="ow">in</span> <span class="mf">4.</span><span class="n">x</span><span class="p">)</span>
<span class="n">E</span>       <span class="n">The</span> <span class="n">vnode</span> <span class="ow">is</span> <span class="n">expanded</span> <span class="n">so</span> <span class="n">its</span> <span class="n">children</span> <span class="n">are</span> <span class="n">visible</span><span class="o">.</span>
<span class="n">M</span>       <span class="n">The</span> <span class="n">vnode</span> <span class="ow">is</span> <span class="n">marked</span><span class="o">.</span>
<span class="n">T</span>       <span class="n">The</span> <span class="n">vnode</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">top</span> <span class="n">visible</span> <span class="n">node</span><span class="o">.</span>
<span class="n">V</span>       <span class="n">The</span> <span class="n">vnode</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">current</span> <span class="n">vnode</span><span class="o">.</span>
</pre></div>
</div>
<p>For example, <code class="docutils literal notranslate"><span class="pre">a=&quot;EM&quot;</span></code>  specifies that the vnode is expanded and is marked.</p>
</dd>
</dl>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">&lt;tnodes&gt;</span></code></dt><dd><p>A single <code class="docutils literal notranslate"><span class="pre">&lt;tnodes&gt;</span></code> element contains a non-nested list of <code class="docutils literal notranslate"><span class="pre">&lt;t&gt;</span></code> elements.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">&lt;t&gt;</span></code></dt><dd><p>This element represents the body text of the corresponding &lt;v&gt; element.
It has this form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">t</span> <span class="n">tx</span><span class="o">=</span><span class="s2">&quot;&lt;gnx&gt;&quot;</span><span class="o">&gt;</span><span class="n">sss</span><span class="o">&lt;/</span><span class="n">t</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">tx</span></code> attribute is required.
The <code class="docutils literal notranslate"><span class="pre">t</span></code> attribute of <code class="docutils literal notranslate"><span class="pre">&lt;v&gt;</span></code> elements refer to this <code class="docutils literal notranslate"><span class="pre">tx</span></code> attribute.
<code class="docutils literal notranslate"><span class="pre">sss</span></code> is the body text encoded with the usual XML escapes.</p>
<p><strong>New in 4.0</strong>: Plugins and scripts may add attributes to <code class="docutils literal notranslate"><span class="pre">&lt;v&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">&lt;t&gt;</span></code>
elements. See <a class="reference external" href="writingPlugins.html">Writing plugins</a> for details.</p>
</dd>
</dl>
</section>
<section id="format-of-external-files">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Format of external files</a><a class="headerlink" href="#format-of-external-files" title="Link to this heading">¶</a></h2>
<p>This section describes Leo’s <a class="reference external" href="glossary.html#sentinel-lines">sentinel lines</a>, comment used in external files.</p>
<p id="index-0">External files created by <code class="docutils literal notranslate"><span class="pre">&#64;file</span></code> use gnx’s in <code class="docutils literal notranslate"><span class="pre">&#64;+node</span></code> sentinels. Such gnx’s permanently and uniquely identify nodes. Gnx’s have the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">id</span><span class="o">.</span><span class="n">yyyymmddhhmmss</span>
<span class="nb">id</span><span class="o">.</span><span class="n">yyyymmddhhmmss</span><span class="o">.</span><span class="n">n</span>
</pre></div>
</div>
<p>The second form is used if two gnx’s would otherwise be identical.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">id</span></code> is a string unique to a developer, e.g., a git id.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">yyyymmddhhmmss</span></code> is the node’s creation date.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n</span></code> is an integer.</p></li>
</ul>
<p>Closing sentinels are required for section references and the <code class="docutils literal notranslate"><span class="pre">&#64;all</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;others</span></code> directives, collectively known as <strong>embedding constructs.</strong> Proof: These constructs do not terminate the node in which they appear. Without a closing sentinel there would be no way to know where the construct ended and the following lines of the enclosing node began.</p>
<p>Here are the sentinels used by modern versions of Leo, in alphabetical order.</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">&#64;&lt;&lt;</span></code></dt><dd><p>Sentinels of the form <code class="docutils literal notranslate"><span class="pre">&#64;&lt;&lt;section_name&gt;&gt;</span></code> represent section references.</p>
<p>If the reference does not end the line, the sentinel line ending the
expansion is followed by the remainder of the reference line. This
allows the Read code to recreate the reference line exactly.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">&#64;&#64;</span></code></dt><dd><p>This sentinel represents any line starting with <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> in body text
except <code class="docutils literal notranslate"><span class="pre">&#64;&lt;whitespace&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;doc</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;others</span></code>.
Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">@</span><span class="nd">@nocolor</span>
<span class="o">@</span><span class="nd">@pagewidth</span> <span class="mi">80</span>
<span class="o">@</span><span class="nd">@tabwidth</span> <span class="o">-</span><span class="mi">4</span>
<span class="o">@</span><span class="nd">@c</span>
</pre></div>
</div>
</dd>
</dl>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">&#64;+all</span></code> and <code class="docutils literal notranslate"><span class="pre">-all</span></code></dt><dd><p>These sentinels mark the range of``&#64;all`` directives.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">&#64;at</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;doc</span></code></dt><dd><p>These sentinels mark the range of <code class="docutils literal notranslate"><span class="pre">&#64;doc</span></code> parts.</p>
</dd>
</dl>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">&#64;&#64;delims</span></code></dt><dd><p>This sentinel marks the range of an <code class="docutils literal notranslate"><span class="pre">&#64;delims</span></code> directive.  <br />
The range continues until the next <code class="docutils literal notranslate"><span class="pre">&#64;delims</span></code> directive.</p>
<p>Adding, deleting or changing <code class="docutils literal notranslate"><span class="pre">&#64;&#64;delim</span></code> <em>sentinels</em> will destroy Leo’s
ability to read the external file.</p>
<p>Mistakes in using the <code class="docutils literal notranslate"><span class="pre">&#64;delims</span></code> <em>directives</em> have no effect on Leo,
though such mistakes will thoroughly mess up a external file as far as
compilers, HTML renderers, etc. are concerned.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">&#64;&#64;section-delims</span></code></dt><dd><p>This sentinel represents the <code class="docutils literal notranslate"><span class="pre">&#64;section-delims</span></code> directive. <br />
Such must appear in the root <code class="docutils literal notranslate"><span class="pre">&#64;&lt;file&gt;</span></code> node.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">&#64;+leo</span></code></dt><dd><p>This sentinel marks the start of any external file.  <br />
This sentinel has the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">opening_delim</span><span class="o">&gt;</span><span class="nd">@leo</span><span class="o">&lt;</span><span class="n">closing_delim</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The read code uses single-line comments if <code class="docutils literal notranslate"><span class="pre">&lt;closing_delim&gt;</span></code> is empty.  <br />
The write code generates single-line comments if possible.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">&#64;+leo</span></code> sentinel contains other information. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">opening_delim</span><span class="o">&gt;</span><span class="nd">@leo</span><span class="o">-</span><span class="n">ver</span><span class="o">=</span><span class="mi">4</span><span class="o">-</span><span class="n">thin</span><span class="o">&lt;</span><span class="n">closing_delim</span><span class="o">&gt;</span>
</pre></div>
</div>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">&#64;-leo</span></code></dt><dd><p>This sentinel marks the end of the Leo file. <br />
Nothing but whitespace should follow this directive.</p>
</dd>
</dl>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">&#64;+node</span></code></dt><dd><p>This sentinel marks the start of a node:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">@+</span><span class="n">node</span><span class="p">:</span><span class="n">gnx</span><span class="p">:</span><span class="o">&lt;</span><span class="n">headline</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Nodes continue until the next <code class="docutils literal notranslate"><span class="pre">&#64;+node</span></code>, <code class="docutils literal notranslate"><span class="pre">at-all</span></code> or <code class="docutils literal notranslate"><span class="pre">at-others</span></code> sentinel.</p>
</dd>
</dl>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">&#64;+others</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;-others</span></code></dt><dd><p>These sentinels mark the range of an <code class="docutils literal notranslate"><span class="pre">&#64;others</span></code> directive.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">&#64;verbatim</span></code></dt><dd><p>This sentinel indicates that the next line of the external file is not
a sentinel. This escape convention allows body text to contain lines
that would otherwise be considered sentinel lines.</p>
</dd>
</dl>
</section>
<section id="the-leonine-way-to-refactor-code">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">The Leonine way to refactor code</a><a class="headerlink" href="#the-leonine-way-to-refactor-code" title="Link to this heading">¶</a></h2>
<p>This paper explains how to use cff (clone-find-flattened) while
refactoring code. I could not have completed the refactoring of Leo’s
atFile write code without using continuous, extensive use of cff.</p>
<p>There are two key ideas:</p>
<ol class="arabic simple">
<li><p>The clones produced by cff are short-term or medium-term data,
easily created and easily dispensed with.</p></li>
</ol>
<p>Such clones are valuable, but not precious. They will eventually be discarded.</p>
<ol class="arabic simple" start="2">
<li><p>Unlike tags (or any other kind of non-Leonine data), the clones
produced by cff can be reorganized.</p></li>
</ol>
<p>This is the priceless, unique advantage of clones.  You don’t understand clones if you don’t get this.</p>
<p>Example</p>
<ol class="arabic simple">
<li><p>While refactoring, it is essential to see all actual uses of a
symbol (method, or ivar, whatever).</p></li>
</ol>
<p>The starting point is to use cff to find all potential uses of the
symbol. If multiple files or classes use the symbol, you can use the
suboutline-only option to limit the matches created by cff.</p>
<ol class="arabic simple" start="2">
<li><p>After finding all potential uses of the symbol, you can reorganize
the resulting clones as follows:</p></li>
</ol>
<ul class="simple">
<li><p>Delete nodes that are completely irrelevant.</p></li>
<li><p>Squirrel away likely-irrelevant nodes in a new organizer node.</p></li>
<li><p>Highlight the defining node, say by making it the preceding sibling of the cff node.</p></li>
<li><p>Leave all actual uses of the symbol where they are.</p></li>
</ul>
<ol class="arabic simple" start="3">
<li><p>You have now focused your attention on the nodes that will likely
change.</p></li>
</ol>
<p>You can now rerun the search only on those cloned nodes to see all
instances of the symbol that might be changed. This is a crucial
double check on proposed changes.</p>
<p>Summary</p>
<p>I highly recommend that all Leonine programmers use the approach just
described when refactoring code.</p>
<p>Neither tags, nor filters, nor refactoring packages can emulate the
Leonine way of refactoring.</p>
</section>
<section id="theory-of-operation-c-deletepositionsinlist">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Theory of operation: c.deletePositionsInList</a><a class="headerlink" href="#theory-of-operation-c-deletepositionsinlist" title="Link to this heading">¶</a></h2>
<p>The positions passed to p.deletePositionsInList only <em>specify</em> the desired
changes; the only way to <em>make</em> those changes is to operate on vnodes!</p>
<p>Consider this outline, containing no clones:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+</span> <span class="n">ROOT</span>
  <span class="o">-</span> <span class="n">A</span>
  <span class="o">-</span> <span class="n">B</span>
</pre></div>
</div>
<p>The fundamental problem is this. If we delete node A, the index of
node B in ROOT.children will change. This problem has (almost) nothing
to do with clones or positions.</p>
<p><strong>Proof that c.deletePositionsInList is correct</strong></p>
<p>Clearly, deleting a positions ultimately means changing vnodes,
specifically, v.parents and v.children for v in some set of vnodes. We must
show that the particular set of changed vnodes in the new code is the
correct set of vnodes, and that the changes made to that set are correct.
This is far from obvious at first glance.</p>
<p><strong>The new code</strong></p>
<p>Here is Vitalije’s version of c.deletePositionsInList, without the docstring:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">deletePositionsInList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aList</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="c1"># Ensure all positions are valid.</span>
    <span class="n">aList</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">aList</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">positionExists</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">aList</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">p2link</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="n">parent_v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">stack</span> <span class="k">else</span> <span class="n">c</span><span class="o">.</span><span class="n">hiddenRootNode</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span><span class="p">,</span> <span class="n">parent_v</span>

    <span class="n">links_to_be_cut</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">p2link</span><span class="p">,</span> <span class="n">aList</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># The main loop.</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">links_to_be_cut</span><span class="p">:</span>
        <span class="n">child_v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">child_v</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<p>To begin the proof, note that the main loop has the expected “form”. That
is, when we delete a node, we will:</p>
<ol class="arabic simple">
<li><p>Delete child_v = v.children[i] for some v and i.</p></li>
<li><p>Delete child_v from its parents array.</p></li>
</ol>
<p>v.parents is an unordered array, so child_v.parents.remove(v) is all that
is needed. This line might crash if one of the positions is invalid. It
will also crash if v is not present in child_v.parents. I’ll discuss this
later.</p>
<p>To complete the proof, we must show that the main loop deletes all and only
those vnodes implied by the positions in aList. We can tentatively assume
that the main loop will work properly if that data in links_to_be_cut is
correct, but there are some subtleties lurking here which I’ll discuss later.</p>
<p>The following code creates links_to_be_cut:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">p2link</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">parent_v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">stack</span> <span class="k">else</span> <span class="n">c</span><span class="o">.</span><span class="n">hiddenRootNode</span>
    <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span><span class="p">,</span> <span class="n">parent_v</span>

<span class="n">links_to_be_cut</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">p2link</span><span class="p">,</span> <span class="n">aList</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<p>This is elegant (compressed) code. Let’s examine it carefully…</p>
<p>p2link produces tuples (childIndex, parent_v). These become bound to i, v
in the main loop:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># The main loop.</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">links_to_be_cut</span><span class="p">:</span>
    <span class="n">child_v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">child_v</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<p>To make this work, parent_v must be the vnode whose i’th child should be
deleted:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">parent_v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">stack</span> <span class="k">else</span> <span class="n">c</span><span class="o">.</span><span class="n">hiddenRootNode</span>
</pre></div>
</div>
<ul class="simple">
<li><p>p.stack entries have the form (v, childIndex), so p.stack[-1] is the
position p’s immediate parent vnode, if p has a parent. Otherwise,
c.hiddenRootNode is the proper parent vnode.</p></li>
<li><p>p._childIndex is also the correct value for i.</p></li>
</ul>
<p>We have just proved the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Deleting</span> <span class="n">position</span> <span class="n">p</span> <span class="n">means</span> <span class="n">executing</span> <span class="n">the</span> <span class="n">main</span> <span class="n">loop</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="n">returned</span> <span class="n">by</span> <span class="n">p2link</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Sorting and filtering</strong></p>
<p>The following line filters and sorts the results produced by p2link:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">links_to_be_cut</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">p2link</span><span class="p">,</span> <span class="n">aList</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>Let’s break this into parts, from “inside” to “outside”</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">map(p2link,</span> <span class="pre">aList)</span></code> applies <code class="docutils literal notranslate"><span class="pre">p2link</span></code> to every position in <code class="docutils literal notranslate"><span class="pre">aList</span></code>.
The result is a list of tuples <code class="docutils literal notranslate"><span class="pre">(i,</span> <span class="pre">v)</span></code>. This list may contain
duplicates.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">set(map(p2link,</span> <span class="pre">aList)</span></code> removes those duplicates.
Let <strong>theSet</strong> be <code class="docutils literal notranslate"><span class="pre">set(map(p2link,</span> <span class="pre">aList)</span></code>.</p></li>
<li><p>Finally, <code class="docutils literal notranslate"><span class="pre">sorted(theSet,</span> <span class="pre">key=lambda</span> <span class="pre">x:-x[0])</span></code> creates a generator
equivalent to a sorted list.</p></li>
</ul>
<p>The generator will deliver the tuples in descending order of <code class="docutils literal notranslate"><span class="pre">i</span></code>, when
several tuples have the same vnode <code class="docutils literal notranslate"><span class="pre">v</span></code>. The generator does not order
tuples on <code class="docutils literal notranslate"><span class="pre">v</span></code>, and there is no need to do so.</p>
<p>It’s easy to understand the intent of this sort order. The main loop
contains this line:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">child_v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
<p>The sort order means that <code class="docutils literal notranslate"><span class="pre">pop(i)</span></code> happens before <code class="docutils literal notranslate"><span class="pre">pop(j)</span></code> if <code class="docutils literal notranslate"><span class="pre">i</span> <span class="pre">&gt;</span>
<span class="pre">j</span></code>. This condition ensures that the precomputed values of <code class="docutils literal notranslate"><span class="pre">i</span></code> won’t
change in the main loop.</p>
<p><strong>Completing the proof</strong></p>
<p>The algorithm appears sound. The tuples <code class="docutils literal notranslate"><span class="pre">(i,</span> <span class="pre">v)</span></code> computed from
<code class="docutils literal notranslate"><span class="pre">p2link(p)</span></code> correctly describe the work to be done. Filtering ensures
that the work is done once. Sorting ensures that child indices <code class="docutils literal notranslate"><span class="pre">i</span></code> will
not change during the main loop.</p>
<p>The tuples are sorted on <code class="docutils literal notranslate"><span class="pre">i</span></code>, but not <code class="docutils literal notranslate"><span class="pre">v</span></code>. <code class="docutils literal notranslate"><span class="pre">aList</span></code> can contain positions
in any order, so we know only that for any particular vnode <code class="docutils literal notranslate"><span class="pre">v</span></code> the main loop
will handle tuples <code class="docutils literal notranslate"><span class="pre">(i1,</span> <span class="pre">v),</span> <span class="pre">(i2,</span> <span class="pre">v),</span> <span class="pre">...</span></code> in the correct order.</p>
<p>There are two final questions to consider:</p>
<p>First, does the order in which the main loop handles vnodes matter?</p>
<p>No. The vnode data are independent. The main loop works regardless of
whether a vnode has already been unlinked.</p>
<p>Second, could the following lines ever fail?</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">child_v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="n">child_v</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<p>No. Sorting and filtering ensure that tuples are unique. <code class="docutils literal notranslate"><span class="pre">v</span></code> is guaranteed to
be in <code class="docutils literal notranslate"><span class="pre">child_v.parents</span></code> because <code class="docutils literal notranslate"><span class="pre">v.children[i]</span></code> must exist.</p>
<p>This concludes the proof.</p>
<p><strong>Discussion</strong></p>
<p>The algorithm is sound because the tuples <code class="docutils literal notranslate"><span class="pre">(i,</span> <span class="pre">v)</span></code> contain no duplicates.
For any particular <code class="docutils literal notranslate"><span class="pre">v</span></code>, the main loop will process the tuples in descending
order of <code class="docutils literal notranslate"><span class="pre">i</span></code>. This resolves the question of whether deleting already deleted
positions is valid.</p>
</section>
<section id="leo-s-colorizer-theory-of-operation">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Leo’s Colorizer: Theory of Operation</a><a class="headerlink" href="#leo-s-colorizer-theory-of-operation" title="Link to this heading">¶</a></h2>
<p>Are you sure you want to read this appendix? It is intended <em>only</em> for Leo’s core developers.</p>
<p>This appendix contains the theory of operation for the <code class="docutils literal notranslate"><span class="pre">JEditColorizer</span></code> (<strong>jedit</strong>) class in <code class="docutils literal notranslate"><span class="pre">leoColorizer.py</span></code>. Unless qualified, <em>all methods are members of the jedit class</em>.</p>
<p><strong>Executive summary</strong></p>
<p>Use the <code class="docutils literal notranslate"><span class="pre">--trace=coloring</span></code> to see the colorizer in action.</p>
<p>The jedit class collaborates with the <strong>qsh</strong>, a singleton instance of the <a class="reference external" href="https://doc.qt.io/qt-6/qsyntaxhighlighter.html">QSyntaxHighlighter</a> class.</p>
<p>This collaboration allows the qsh to <em>minimize</em> the calls to <code class="docutils literal notranslate"><span class="pre">jedit.redraw</span></code>. The qsh calls <code class="docutils literal notranslate"><span class="pre">redraw(s)</span></code> <em>only</em> if line <code class="docutils literal notranslate"><span class="pre">s</span></code> could possibly need recoloring.</p>
<p>Leo’s core <em>must never</em> call <code class="docutils literal notranslate"><span class="pre">redraw</span></code>! These calls must happen automatically. Calling <code class="docutils literal notranslate"><span class="pre">redraw</span></code> from Leo’s core could cause hard-to-find bugs!</p>
<p><strong>States</strong> allow the jedit class to handle constructs like strings or comments that continue from one line to another.</p>
<p><strong>Mode files</strong>, python files in the <code class="docutils literal notranslate"><span class="pre">leo/modes</span></code> directory, tell the jedit class how to colorize specific languages.</p>
<p><strong>Pattern matchers</strong> do the actual syntax coloring.</p>
<section id="components-of-the-jedit-class">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">Components of the jedit class</a><a class="headerlink" href="#components-of-the-jedit-class" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">JEditColorizer</span></code> class consists of <strong>drivers</strong>, <strong>pattern matchers</strong> and various <strong>helper utilities</strong>.</p>
<p><strong>Drivers</strong></p>
<p>The <code class="docutils literal notranslate"><span class="pre">redraw</span></code> and <code class="docutils literal notranslate"><span class="pre">mainLoop</span></code> methods are the interface between the qsh and the methods of the jedit class.</p>
<p><code class="docutils literal notranslate"><span class="pre">qsh.rehighlight</span></code> calls <code class="docutils literal notranslate"><span class="pre">redraw(s)</span></code> to colorize a <em>single</em> line <code class="docutils literal notranslate"><span class="pre">s</span></code>. After initing the <strong>initial state</strong>, <code class="docutils literal notranslate"><span class="pre">redraw</span></code> calls <code class="docutils literal notranslate"><span class="pre">mainLoop</span></code>.</p>
<p>Leo’s core <em>must never</em> call <code class="docutils literal notranslate"><span class="pre">redraw</span></code>! Doing so could cause hard-to-find bugs.</p>
<p><code class="docutils literal notranslate"><span class="pre">redraw(s)</span></code> calls <code class="docutils literal notranslate"><span class="pre">mainLoop(s)</span></code> to do the actual syntax coloring.</p>
<p><code class="docutils literal notranslate"><span class="pre">mainLoop(s)</span></code> calls <strong>rule functions</strong> (defined in mode files).</p>
<p>Rule functions delegate their work to exactly one <strong>pattern matcher</strong> (described next). In other words, <em>pattern matchers are callbacks.</em></p>
<p><strong>Pattern matchers</strong></p>
<p>Pattern matchers form the bulk of the jedit class. Each pattern matcher does the following:</p>
<ul>
<li><p>Examines the string <code class="docutils literal notranslate"><span class="pre">s[i:]</span></code>, where s is the argument to <code class="docutils literal notranslate"><span class="pre">mainLoop(s)</span></code>.</p></li>
<li><p>Updates the <strong>ending state</strong> for successful matches.</p></li>
<li><p>Returns an integer <strong>return code</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">complete</span> <span class="n">failure</span><span class="p">:</span> <span class="n">mainLoop</span> <span class="n">returns</span>
 <span class="mi">0</span><span class="p">:</span> <span class="n">partial</span> <span class="n">failure</span><span class="p">:</span> <span class="n">mainLoop</span> <span class="n">tries</span> <span class="n">to</span> <span class="n">match</span> <span class="n">other</span> <span class="n">rules</span>
<span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">success</span><span class="p">:</span> <span class="n">mainLoop</span> <span class="n">increments</span> <span class="n">i</span> <span class="n">by</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">tries</span> <span class="n">to</span> <span class="n">match</span> <span class="n">other</span> <span class="n">rules</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="the-big-challenge">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">The big challenge</a><a class="headerlink" href="#the-big-challenge" title="Link to this heading">¶</a></h3>
<p>The qsh can (and will) call <code class="docutils literal notranslate"><span class="pre">recolor(s)</span></code> where s is <em>out-of-sequence</em> with the preceding call. For example, the following snippet is typical in <code class="docutils literal notranslate"><span class="pre">&#64;language</span> <span class="pre">jupytext</span></code> nodes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># %% (like @language python)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">spam</span><span class="p">():</span>

<span class="c1"># %% [markdown] (like @language md)</span>

<span class="c1"># Section 1</span>
<span class="n">It</span> <span class="n">was</span> <span class="n">the</span> <span class="n">best</span> <span class="n">of</span> <span class="n">times</span><span class="p">;</span> <span class="n">it</span> <span class="n">was</span> <span class="n">the</span> <span class="n">worst</span> <span class="n">of</span> <span class="n">times</span><span class="o">.</span>
</pre></div>
</div>
<p>The user can click (or cut or paste) anywhere in this text. The qsh will then call <code class="docutils literal notranslate"><span class="pre">recolor(s)</span></code> starting with the first changed line.</p>
<p><em>There is no necessary relationship between</em> <code class="docutils literal notranslate"><span class="pre">s</span></code> <em>and the line that</em> <code class="docutils literal notranslate"><span class="pre">recolor</span></code> <em>last saw</em>!</p>
</section>
<section id="about-states-and-restarters">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">About states and restarters</a><a class="headerlink" href="#about-states-and-restarters" title="Link to this heading">¶</a></h3>
<p>States allow the colorizer to handle out-of-order calls to <code class="docutils literal notranslate"><span class="pre">recolor</span></code>.</p>
<p>The colorizer collaborates the qsh in <em>only one way</em>, namely by calling <code class="docutils literal notranslate"><span class="pre">self.highlighter.setCurrentBlockState(n)</span></code>, where <code class="docutils literal notranslate"><span class="pre">n</span></code> is an <em>integer</em> state number.</p>
<p>Internally, the colorizer uses <em>string</em> states. The colorizer’s <strong>state utilities</strong> handle the conversion between integer and string representations.</p>
<p>States represent, for a <em>particular</em> line:</p>
<ul class="simple">
<li><p>Which <code class="docutils literal notranslate"><span class="pre">&#64;language</span></code> directive is in effect.</p></li>
<li><p>Which coloring directive (<code class="docutils literal notranslate"><span class="pre">&#64;killcolor</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;color</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;nocolor</span></code>, etc.) is in effect.</p></li>
<li><p>Whether the coloring for the line <em>continues</em> to the next line.
For example, Python docstrings may span multiple lines.</p></li>
</ul>
<p>A fine point: The state utilities ensure that all integer state numbers are unique and refer to the proper language in effect. For example, if a node contains multiple <code class="docutils literal notranslate"><span class="pre">&#64;language</span></code> directives, the default states of the two languages must have different state numbers!</p>
<p>The colorizer keeps track of states as follows:</p>
<p><code class="docutils literal notranslate"><span class="pre">recolor</span></code> first computes the line’s <strong>initial state</strong> from the <strong>ending state</strong> of the <em>previous</em> line. By default, the initial state becomes the ending state of <em>current</em> state.</p>
<p>Pattern matchers usually leave the ending state unchanged.</p>
<p>If a pattern matcher matches an <code class="docutils literal notranslate"><span class="pre">&#64;language</span></code> or coloring directive, the matcher creates (indirectly, via the state utilities) a new state representing the directive. This is the easy case.</p>
<p>If a pattern matcher matches syntax that continues to the next line, the pattern matcher creates a <strong>restarter matcher</strong> by calling <code class="docutils literal notranslate"><span class="pre">setRestart</span></code>. The restarter matchers are essentially closures, bindings of the pattern matcher <em>and all of its kwargs</em>. The details are hairy, but the coding pattern is the same for all cases. See the source code for details.</p>
</section>
<section id="mode-files">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">Mode files</a><a class="headerlink" href="#mode-files" title="Link to this heading">¶</a></h3>
<p>The <a class="reference external" href="https://www.jedit.org/">jEdit</a> editor drives its syntax colorer using <code class="docutils literal notranslate"><span class="pre">.xml</span></code> files. Leo uses <code class="docutils literal notranslate"><span class="pre">.py</span></code> files instead.</p>
<p>Long ago, Leo’s <code class="docutils literal notranslate"><span class="pre">jEdit2Py</span></code> script created the python <strong>mode files</strong> in the <code class="docutils literal notranslate"><span class="pre">leo/modes</span></code> directory.</p>
<p>Roughly speaking, there is one mode file for every language that Leo can colorize. Over the years, Leo’s devs have modified several of these mode files by hand.</p>
<p><code class="docutils literal notranslate"><span class="pre">init</span></code> sets <code class="docutils literal notranslate"><span class="pre">jedit.rulesDict</span></code> from the mode file for the language in effect. Keys are <strong>lead-in characters</strong>; values are lists of <strong>rule functions</strong> (<strong>rules</strong> for short). Each mode file defines its own rulesDict and rules.</p>
<p><code class="docutils literal notranslate"><span class="pre">mainLoop(s)</span></code> uses the rulesDict to retrieve a list of zero or more rules to be used when scanning s. It’s that simple.</p>
<p>Legacy mode files could collaborate using the <code class="docutils literal notranslate"><span class="pre">delegate</span></code> keyword, but that scheme was (and is) clumsy.</p>
<p>Leo 6.8.3 added <code class="docutils literal notranslate"><span class="pre">leo/modes/jupytext.py</span></code>, a new mode file for <code class="docutils literal notranslate"><span class="pre">&#64;language</span> <span class="pre">jupytext</span></code>. This mode file introduced a new style of collaboration. The mode files for the jupytext, python and markdown languages collaborate <em>directly</em> using modifications of <em>existing</em> rules in <code class="docutils literal notranslate"><span class="pre">python.py</span></code> and <code class="docutils literal notranslate"><span class="pre">md.py</span></code>.</p>
</section>
</section>
<section id="leoast-py">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">leoAst.py</a><a class="headerlink" href="#leoast-py" title="Link to this heading">¶</a></h2>
<p>The classes in <a class="reference external" href="https://github.com/leo-editor/leo-editor/blob/devel/leo/core/leoAst.py">leoAst.py</a>
unify python’s token-based and ast-based worlds by creating two-way links
between tokens in the token list and ast nodes in the parse tree.</p>
<p>leoAst.py is part of <a class="reference external" href="https://leo-editor.github.io/leo-editor/">Leo</a>, and can be used
completely independently of Leo.</p>
<p>You must use Leo to see the intended outline structure of the code. Without
Leo, you will see special <strong>sentinel comments</strong> that create Leo’s outline
structure. These comments have the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#@&lt;comment-kind&gt;:&lt;user-id&gt;.&lt;timestamp&gt;.&lt;number&gt;: &lt;outline-level&gt; &lt;headline&gt;</span>
</pre></div>
</div>
<p>If you have any trouble installing or using this code, please help for help
on <a class="reference external" href="https://groups.google.com/forum/#!forum/leo-editor">Leo’s forum</a></p>
<section id="running-leoast-py">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">Running leoAst.py</a><a class="headerlink" href="#running-leoast-py" title="Link to this heading">¶</a></h3>
<section id="running-leoast-py-from-the-command-line">
<h4>Running leoAst.py from the command line<a class="headerlink" href="#running-leoast-py-from-the-command-line" title="Link to this heading">¶</a></h4>
<p>leoAst.py is designed to be run from the command line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">:</span>
    <span class="n">leoAst</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">help</span>
    <span class="n">leoAst</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="o">--</span><span class="n">fstringify</span> <span class="o">|</span> <span class="o">--</span><span class="n">fstringify</span><span class="o">-</span><span class="n">diff</span> <span class="o">|</span> <span class="o">--</span><span class="n">orange</span> <span class="o">|</span> <span class="o">--</span><span class="n">orange</span><span class="o">-</span><span class="n">diff</span><span class="p">]</span> <span class="n">PATHS</span>
    <span class="n">leoAst</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">py</span><span class="o">-</span><span class="n">cov</span> <span class="p">[</span><span class="n">ARGS</span><span class="p">]</span>
    <span class="n">leoAst</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">pytest</span> <span class="p">[</span><span class="n">ARGS</span><span class="p">]</span>
    <span class="n">leoAst</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">unittest</span> <span class="p">[</span><span class="n">ARGS</span><span class="p">]</span>

<span class="n">examples</span><span class="p">:</span>
    <span class="o">--</span><span class="n">py</span><span class="o">-</span><span class="n">cov</span> <span class="s2">&quot;-f TestOrange&quot;</span>
    <span class="o">--</span><span class="n">pytest</span> <span class="s2">&quot;-f TestOrange&quot;</span>
    <span class="o">--</span><span class="n">unittest</span> <span class="n">TestOrange</span>

<span class="n">positional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="n">PATHS</span>              <span class="n">directory</span> <span class="ow">or</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">files</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>         <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
  <span class="o">--</span><span class="n">fstringify</span>       <span class="n">leonine</span> <span class="n">fstringify</span>
  <span class="o">--</span><span class="n">fstringify</span><span class="o">-</span><span class="n">diff</span>  <span class="n">show</span> <span class="n">fstringify</span> <span class="n">diff</span>
  <span class="o">--</span><span class="n">orange</span>           <span class="n">leonine</span> <span class="n">Black</span>
  <span class="o">--</span><span class="n">orange</span><span class="o">-</span><span class="n">diff</span>      <span class="n">show</span> <span class="n">orange</span> <span class="n">diff</span>
  <span class="o">--</span><span class="n">py</span><span class="o">-</span><span class="n">cov</span>           <span class="n">run</span> <span class="n">pytest</span> <span class="o">--</span><span class="n">cov</span> <span class="n">on</span> <span class="n">leoAst</span><span class="o">.</span><span class="n">py</span>
  <span class="o">--</span><span class="n">pytest</span>           <span class="n">run</span> <span class="n">pytest</span> <span class="n">on</span> <span class="n">leoAst</span><span class="o">.</span><span class="n">py</span>
  <span class="o">--</span><span class="n">unittest</span>         <span class="n">run</span> <span class="n">unittest</span> <span class="n">on</span> <span class="n">leoAst</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
</section>
<section id="running-the-code-python-programmatically">
<h4>Running the code python programmatically<a class="headerlink" href="#running-the-code-python-programmatically" title="Link to this heading">¶</a></h4>
<p>To access the code, do one of the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">leoAst</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">leo.core.leoAst</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">leoAst</span>
</pre></div>
</div>
<p>You can then run the fstringify commands as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">changed</span> <span class="o">=</span> <span class="n">leoAst</span><span class="o">.</span><span class="n">Fstringify</span><span class="p">()</span><span class="o">.</span><span class="n">fstringify_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="n">changed</span> <span class="o">=</span> <span class="n">leoAst</span><span class="o">.</span><span class="n">Fstringify</span><span class="p">()</span><span class="o">.</span><span class="n">fstringify_diff_files</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="running-unit-tests-and-coverage-tests-programmatically">
<h4>Running unit tests and coverage tests programmatically<a class="headerlink" href="#running-unit-tests-and-coverage-tests-programmatically" title="Link to this heading">¶</a></h4>
<p>The following runs all unit tests for leoAst.py:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">leo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">leoAst</span>
</pre></div>
</div>
<p>The following runs coverage tests:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pytest</span> <span class="o">-</span><span class="n">x</span> <span class="o">--</span><span class="n">cov</span><span class="o">-</span><span class="n">report</span> <span class="n">html</span> <span class="o">--</span><span class="n">cov</span><span class="o">-</span><span class="n">report</span> <span class="n">term</span><span class="o">-</span><span class="n">missing</span> <span class="o">--</span><span class="n">cov</span><span class="o">=</span><span class="n">leo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">leoAst</span> <span class="n">leo</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">leoAst</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
</section>
</section>
<section id="tokenorder-classes-theory-of-operation">
<h3><a class="toc-backref" href="#id13" role="doc-backlink">TokenOrder classes: Theory of operation</a><a class="headerlink" href="#tokenorder-classes-theory-of-operation" title="Link to this heading">¶</a></h3>
<p>This is the Theory of Operation for the TokenOrderGenerator (TOG) class and
related classes.</p>
<section id="token-order-classes">
<h4>Token-order classes<a class="headerlink" href="#token-order-classes" title="Link to this heading">¶</a></h4>
<p>The <strong>TokenOrderGenerator</strong> (TOG) class injects two-way links between all
tokens and the corresponding ast nodes. The TOG class also injects
parent/child links into all ast nodes.</p>
<p>The TOG class defines visitors that visit ast nodes in <strong>token order</strong>, the
traversal order that corresponds to the order of the tokens produced by
python’s tokenizer module. The only way to ensure this correspondence is to
use separate visitors for all ast nodes. All visitors are straightforward
generators.</p>
<p>TOG visitors eventually call <code class="docutils literal notranslate"><span class="pre">TOG.sync_token</span></code>, which checks that that tokens
are, in fact, visited in the correct order. <code class="docutils literal notranslate"><span class="pre">TOG.sync_token</span></code> is an
ever-present unit test.</p>
<p>The <strong>TokenOrderTraversal</strong> (TOT) class uses the parent/child links created
by the TOG class. TOT.traverse contains a single for-loop that calls all
nodes of the parse tree in token order. This loop is extremely fast. Using
the TOT class, client code can easily modify the token list or parse tree
as desired.</p>
</section>
<section id="other-classes">
<h4>Other classes<a class="headerlink" href="#other-classes" title="Link to this heading">¶</a></h4>
<p>The <strong>Token</strong> class represents one token, created by tokenize.tokenize.</p>
<p>The <strong>Fstringify</strong> class is an re-implementation of the external fstringify
project using the TOG class.</p>
<p>The <strong>Orange</strong> class is a re-implementation of the black project. <br />
The name “Orange” is a play on words: “Orange is the new black”.</p>
<p>The <strong>AstDumper</strong> class provides an extensive set of tools for examining
token lists, parse trees, and the links between them.</p>
<p>The <strong>BaseTest</strong> class provides common infrastructure for all other test classes.
<em>Important</em>: BaseTest.make_data is, all by itself, a very strong unit test.</p>
</section>
<section id="significant-vs-insignificant-tokens">
<h4>Significant vs insignificant tokens<a class="headerlink" href="#significant-vs-insignificant-tokens" title="Link to this heading">¶</a></h4>
<p>The distinction between <strong>significant</strong> and <strong>insignificant</strong> tokens is
crucial. Visitors call <code class="docutils literal notranslate"><span class="pre">TOG.gen_token</span></code>, <code class="docutils literal notranslate"><span class="pre">TOG.gen_op</span></code>, etc. <em>only</em> for
significant tokens. The <code class="docutils literal notranslate"><span class="pre">is_significant</span></code> and <code class="docutils literal notranslate"><span class="pre">is_significant_token</span></code>
functions define which tokens are significant.</p>
<p>Visitors can’t know, just by looking at the parse tree, whether the input
contains <em>insignificant</em> tokens. For example, the source tokens might
contain non-essential parentheses, or optional trailing commas, or whether
two statements are separated by a semicolon.</p>
</section>
<section id="helping-tog-visitors">
<h4>Helping TOG visitors<a class="headerlink" href="#helping-tog-visitors" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">TOG.do_If</span></code> visitor calls <code class="docutils literal notranslate"><span class="pre">TOG.find_next_significant_token</span></code> to
determine whether <code class="docutils literal notranslate"><span class="pre">TOG.do_If</span></code> should generate an “if” or an “elif” token.
This help is essential, because the following two source files generate
identical parse trees!</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="mi">1</span><span class="p">:</span>            <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">pass</span>             <span class="k">pass</span>
<span class="k">else</span><span class="p">:</span>            <span class="k">elif</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">if</span> <span class="mi">2</span><span class="p">:</span>            <span class="k">pass</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p>Similarly, the <code class="docutils literal notranslate"><span class="pre">TOG.do_Str</span></code> and <code class="docutils literal notranslate"><span class="pre">TOG.do_JoinedStr</span></code> visitors call
<code class="docutils literal notranslate"><span class="pre">TOG.get_concatenated_string_tokens</span></code> to handle one ore more concatenated
string tokens.</p>
<p>Finally, <code class="docutils literal notranslate"><span class="pre">TOG.do_slice</span></code> calls <code class="docutils literal notranslate"><span class="pre">TOG.find_next_significant_token</span></code> to determine
whether a slice without a step contains an optional colon.</p>
<p><code class="docutils literal notranslate"><span class="pre">TOG.find_next_significant_token</span></code> and <code class="docutils literal notranslate"><span class="pre">TOG.get_concatenated_string_tokens</span></code> are
crucial inventions. TOG class would not be possible without them.</p>
</section>
<section id="syncing-tokens">
<h4>Syncing tokens<a class="headerlink" href="#syncing-tokens" title="Link to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">TOG.px</span></code> is an index into the token list. It is either -1, or it points
at the previous significant token. <em>Note</em>: TOG.find_next_significant_token
and TOG.get_concatenated_string_tokens use TOG.px, but never change TOG.px.</p>
<p>TOG.sync_token(self, kind, val) associates tokens with ast nodes as
follows:</p>
<ol class="arabic simple">
<li><p>If (kind, val) denote an <em>insignificant</em> token, TOG.sync_token does
nothing.</p></li>
<li><p>Otherwise, (kind, val) denotes a <em>significant</em> token. TOG.sync_token
associates that token, <em>plus</em> all previous <em>insignificant</em> tokens with
self.node, the ast node presently being visited.</p></li>
</ol>
<p>In addition, if (kind, val) denotes a <em>significant</em> token, TOG.sync_token
checks that the next <em>significant</em> token in the token list has the expected
kind and value. This is done as follows:</p>
<ul class="simple">
<li><p>TOG.sync_token advances TOG.px to point at the next significant token,
call it T.</p></li>
<li><p>TOG.raises AssignLinksError if (T.kind, T.value) != (kind, val)</p></li>
</ul>
<p>To summarize token syncing:</p>
<ul class="simple">
<li><p>The TOG.px index tracks the last-seen <em>significant</em> token.</p></li>
<li><p>TOG.px advances monotonically through the token list.</p></li>
<li><p>TOG.find_next_significant_token and TOG.get_concatenated_string_tokens
scan forward through the token list using a private copy of TOG.px. These
methods never change TOG.px itself.</p></li>
<li><p>This token-syncing machinery is the <em>simplest</em> thing that could possibly
work. It is also the <em>fastest</em> thing that could possibly work.</p></li>
</ul>
</section>
<section id="figures-of-merit">
<h4>Figures of merit<a class="headerlink" href="#figures-of-merit" title="Link to this heading">¶</a></h4>
<p><strong>Simplicity</strong>:</p>
<ul class="simple">
<li><p>The distinction between significant and insignificant tokens makes
token-order traversals possible. This distinction drastically simplifies
TOG visitors. They never have to generate insignificant tokens!</p></li>
<li><p>TOG.find_next_significant_token and TOG.get_concatenated_string_tokens()
use TOG.px to look ahead in the token list.</p></li>
<li><p>It took a long time to realize that the parse tree needs help from the
token list, not the other way around!</p></li>
</ul>
<p><strong>Speed</strong>: The TOG creates links between tokens and ast nodes in roughly the time
taken by python’s tokenize.tokenize and ast.parse library methods. The TOT
class traverses trees annotated with parent/child links even more quickly.</p>
<p>TOG class avoids both <code class="docutils literal notranslate"><span class="pre">ast.fix_missing_locations</span></code> and <code class="docutils literal notranslate"><span class="pre">ast.get_source_segment</span></code>,
which are too slow to be useful.</p>
<p><strong>Memory</strong>: The TOG class makes no significant demand on python’s resources:</p>
<ul class="simple">
<li><p>Generators add nothing to python’s call stack.</p></li>
<li><p>The <em>only</em> variable-length data created by the TOG is TOG.node_stack.
This stack resides in python’s heap, so its length is unimportant. In the
worst case, it might contain a few thousand entries.</p></li>
<li><p>The TOT uses no variable-length data whatever.</p></li>
</ul>
</section>
</section>
<section id="maintaining-leoast-py">
<h3><a class="toc-backref" href="#id14" role="doc-backlink">Maintaining leoAst.py</a><a class="headerlink" href="#maintaining-leoast-py" title="Link to this heading">¶</a></h3>
<p>New ast nodes are sometimes required to support new language features,
especially language features that require new syntax or keywords. Python
has added new nodes fairly often in the past. New nodes may be added in
future. When that happens, the following changes will be needed to
leoAst.py:</p>
<ul class="simple">
<li><p>Add a visitor for the new node.</p></li>
<li><p>Add one or more unit tests that fully cover the new visitor.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">test_visitors_exist</span></code> unit test checks that visitors exist for all
ast nodes defined by to a particular version of python.</p>
<p>See <a class="reference external" href="https://github.com/leo-editor/leo-editor/issues/1440">Leo issue #1440</a> for notes relating to the code.</p>
</section>
</section>
<section id="unicode-reference">
<h2><a class="toc-backref" href="#id15" role="doc-backlink">Unicode reference</a><a class="headerlink" href="#unicode-reference" title="Link to this heading">¶</a></h2>
<p>Leo uses unicode internally for all strings.</p>
<ol class="arabic">
<li><p>Leo converts headline and body text to unicode when reading .leo files and external files. Both .leo files and external files may specify their encoding.  The default is utf-8. If the encoding used in a external file is not “utf-8” it is represented in the &#64;+leo sentinel line. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="c1">#@+leo-encoding=iso-8859-1.</span>

<span class="n">The</span> <span class="n">utf</span><span class="o">-</span><span class="mi">8</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="n">a</span> <span class="s2">&quot;lossless&quot;</span> <span class="n">encoding</span> <span class="p">(</span><span class="n">it</span> <span class="n">can</span> <span class="n">represent</span> <span class="nb">all</span>
<span class="n">unicode</span> <span class="n">code</span> <span class="n">points</span><span class="p">),</span> <span class="n">so</span> <span class="n">converting</span> <span class="n">to</span> <span class="ow">and</span> <span class="kn">from</span><span class="w"> </span><span class="nn">utf</span><span class="o">-</span><span class="mi">8</span> <span class="n">plain</span>
<span class="n">strings</span> <span class="n">will</span> <span class="n">never</span> <span class="n">cause</span> <span class="n">a</span> <span class="n">problem</span><span class="o">.</span> <span class="n">When</span> <span class="n">reading</span> <span class="ow">or</span> <span class="n">writing</span> <span class="n">a</span>
<span class="n">character</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">a</span> <span class="s2">&quot;lossy&quot;</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">Leo</span> <span class="n">converts</span> <span class="n">such</span> <span class="n">characters</span>
<span class="n">to</span> <span class="s1">&#39;?&#39;</span> <span class="ow">and</span> <span class="n">issues</span> <span class="n">a</span> <span class="n">warning</span><span class="o">.</span>
</pre></div>
</div>
</li>
<li><p>When writing .leo files and external files Leo uses the same encoding used to read the file, again with utf-8 used as a default.</p></li>
<li><p>leoSettings.leo contains the following Unicode settings, with the defaults as shown:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">default_derived_file_encoding</span> <span class="o">=</span> <span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
    <span class="n">new_leo_file_encoding</span> <span class="o">=</span> <span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>

<span class="n">These</span> <span class="n">control</span> <span class="n">the</span> <span class="n">default</span> <span class="n">encodings</span> <span class="n">used</span> <span class="n">when</span> <span class="n">writing</span> <span class="n">external</span>
<span class="n">files</span> <span class="ow">and</span> <span class="o">.</span><span class="n">leo</span> <span class="n">files</span><span class="o">.</span> <span class="n">Changing</span> <span class="n">the</span> <span class="n">new_leo_file_encoding</span> <span class="n">setting</span>
<span class="ow">is</span> <span class="ow">not</span> <span class="n">recommended</span><span class="o">.</span> <span class="n">See</span> <span class="n">the</span> <span class="n">comments</span> <span class="ow">in</span> <span class="n">leoSettings</span><span class="o">.</span><span class="n">leo</span><span class="o">.</span> <span class="n">You</span> <span class="n">may</span>
<span class="nb">set</span> <span class="n">default_derived_file_encoding</span> <span class="n">to</span> <span class="n">anything</span> <span class="n">that</span> <span class="n">makes</span> <span class="n">sense</span> <span class="k">for</span>
<span class="n">you</span><span class="o">.</span>
</pre></div>
</div>
</li>
<li><p>The &#64;encoding directive specifies the encoding used in a external file. You can’t mix encodings in a single external file.</p></li>
</ol>
</section>
<section id="valid-url-s">
<h2><a class="toc-backref" href="#id16" role="doc-backlink">Valid URL’s</a><a class="headerlink" href="#valid-url-s" title="Link to this heading">¶</a></h2>
<p>Leo checks that the URL is valid before attempting to open it. A valid URL is:</p>
<ul class="simple">
<li><p>3 or more lowercase alphas</p></li>
<li><p>followed by one :</p></li>
<li><p>followed by one or more of:</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$%&amp;'()*+,-./0-9:=?&#64;A-Z_a-z{}~</span></code></p></li>
<li><p>followed by one of: <code class="docutils literal notranslate"><span class="pre">$%&amp;'()*+/0-9:=?&#64;A-Z_a-z}~</span></code></p></li>
</ul>
<p>That is, a comma, hyphen and open curly brace may not be the last character.</p>
<p>URL’s in Leo should contain no spaces: use %20 to indicate spaces.</p>
<p>You may use any type of URL that your browser supports: http, mailto, ftp, file, etc.</p>
</section>
<section id="the-mulder-ream-update-algorithm">
<h2><a class="toc-backref" href="#id17" role="doc-backlink">The Mulder/Ream update algorithm</a><a class="headerlink" href="#the-mulder-ream-update-algorithm" title="Link to this heading">¶</a></h2>
<p>This appendix documents the Mulder/Ream update algorithm in detail, with an informal proof of its correctness.</p>
<p>Prior to Leo 5.1, Leo used Bernhard Mulder’s original algorithm to read &#64;shadow files. Starting with Leo 5.1, Leo uses this algorithm to read both &#64;clean and &#64;shadow files. Conceptually, both algorithms work as described in the next section.</p>
<p>In February 2015 EKR realized that the &#64;shadow algorithm could be used to update &#64;clean (&#64;nosent) files. Simplifying the algorithm instantly became a top priority. The new code emerged several days later, made possible by the x.sentinels array. It is an important milestone in Leo’s history.</p>
<section id="what-the-algorithm-does">
<h3><a class="toc-backref" href="#id18" role="doc-backlink">What the algorithm does</a><a class="headerlink" href="#what-the-algorithm-does" title="Link to this heading">¶</a></h3>
<p>For simplicity, this discussion will assume that we are updating an
external file, x, created with &#64;clean x. The update algorithm works
exactly the same way with &#64;shadow trees.</p>
<p>The algorithm works with <em>any</em> kind of text file. The algorithm uses only
difflib. It knows nothing about the text or its meaning. No parsing is ever
done.</p>
<p>Suppose file x has been changed outside of Leo. When Leo reads x it does
the following:</p>
<ol class="arabic">
<li><p>Recreates the <em>old</em> version of x <em>without</em> sentinels by writing the
&#64;clean x <em>outline</em> into a string, as if it were writing the &#64;clean x
outline again.</p></li>
<li><p>Recreates all the lines of x <em>with</em> sentinels by writing the &#64;clean x
<em>outline</em> into a string, as if it was writing an &#64;file node! Let’s call
these lines the <strong>old sentinels</strong> lines.</p></li>
<li><p>Uses difflib.SequenceMatcher to create a set of diffs between the
old and new versions of x <em>without</em> sentinels.</p>
<p><strong>Terminology</strong>: the diffs tell how to change file a into file b. The
actual code uses this terminology: <strong>a</strong> is set of lines in the old
version of x, <strong>b</strong> is the set of lines in the new version of x.</p>
</li>
<li><p>Creates a set of lines, the <strong>new sentinels lines</strong> using the old
sentinels lines, the a and b lines and the diffs.</p>
<p>This is the magic. Bernhard Mulder’s genius was conceiving that a
three-way merge of lines could produce the new outline, <em>with</em>
sentinels. The code is in x.propagate_changed_lines and its helpers.</p>
</li>
<li><p>Replaces the &#64;clean tree with the new tree created by reading the new
sentinels lines with the &#64;file read logic.</p></li>
</ol>
<p><strong>Important</strong>: The update algorithm never changes sentinels. It never
inserts or deletes nodes. The user is responsible for creating nodes to
hold new lines, or for deleting nodes that become empty as the result of
deleting lines.</p>
</section>
<section id="guesses-don-t-matter">
<h3><a class="toc-backref" href="#id19" role="doc-backlink">Guesses don’t matter</a><a class="headerlink" href="#guesses-don-t-matter" title="Link to this heading">¶</a></h3>
<p>There are several boundary cases that the update algorithm can not resolve.
For example, if a line is inserted between nodes, the algorithm can not
determine whether the line should be inserted at the end of one node or the
start of the next node. Let us call such lines <strong>ambiguous lines</strong>.</p>
<p>The algorithm <em>guesses</em> that ambiguous lines belongs at the end of a node
rather than at the start of the next node. This is usually what is
wanted–we usually insert lines at the end of a node.</p>
<p>Happily, <strong>guesses don’t matter</strong>, for the following reasons:</p>
<ol class="arabic simple">
<li><p>The external file that results from writing the &#64;clean x tree will be
the same as the updated external file <em>no matter where</em> ambiguous lines
are placed. In other words, the update algorithm is <strong>sound</strong>.</p></li>
<li><p>Leo reports nodes that were changed when reading any external file. The
user can review changes to &#64;clean and &#64;file trees in the same way.</p></li>
<li><p>The user can permanently correct any mistaken guess. Guesses only happen
for <em>newly inserted or changed</em> lines. Moving an ambiguous line to the
following node will not change the external file. As a result, the
next time Leo reads the file the line will be placed in the correct node!</p></li>
</ol>
<p>This proves that &#64;shadow and &#64;clean are easy and safe to use. The
remaining sections of this document discuss code-level details.</p>
</section>
<section id="background-of-the-code">
<h3><a class="toc-backref" href="#id20" role="doc-backlink">Background of the code</a><a class="headerlink" href="#background-of-the-code" title="Link to this heading">¶</a></h3>
<p>The algorithm depends on three simple, guaranteed, properties of
SequenceMatcher.opcodes. See
<a class="reference external" href="https://docs.python.org/2/library/difflib.html#sequencematcher-examples">https://docs.python.org/2/library/difflib.html#sequencematcher-examples</a></p>
<p><strong>Fact 1</strong>: The opcodes tell how to turn x.a (a list of lines) into x.b
(another list of lines).</p>
<p>The code uses the a and b terminology. It’s concise and easy to remember.</p>
<p><strong>Fact 2</strong>: The opcode indices ai, aj, bi, bj <em>never</em> change because
neither x.a nor x.b changes.</p>
<p>Plain lines of the result can be built up by copying lines from x.b to x.results:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;replace&#39;</span>   <span class="n">x</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">b1</span><span class="p">:</span><span class="n">b2</span><span class="p">])</span>
<span class="s1">&#39;delete&#39;</span>    <span class="n">do</span> <span class="n">nothing</span>  <span class="p">(</span><span class="n">b1</span> <span class="o">==</span> <span class="n">b2</span><span class="p">)</span>
<span class="s1">&#39;insert&#39;</span>    <span class="n">x</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">b1</span><span class="p">:</span><span class="n">b2</span><span class="p">])</span>
<span class="s1">&#39;equal&#39;</span>     <span class="n">x</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">b1</span><span class="p">:</span><span class="n">b2</span><span class="p">])</span>
</pre></div>
</div>
<p><strong>Fact 3</strong>: The opcodes <em>cover</em> both x.a and x.b, in order, without any gaps.</p>
<p>This is an explicit requirement of sm.get_opcode:</p>
<ul class="simple">
<li><p>The first tuple has ai==aj==bi==bj==0.</p></li>
<li><p>Remaining tuples have ai == (aj from the preceding tuple) and bi == (bj
from the previous tuple).</p></li>
</ul>
<p>Keep in mind this crucial picture:</p>
<ul class="simple">
<li><p>The slices x.a[ai:aj] cover the x.a array, in order without gaps.</p></li>
<li><p>The slices x.b[bi:bj] cover the x.b array, in order without gaps.</p></li>
</ul>
</section>
<section id="aha-the-x-sentinels-array">
<h3><a class="toc-backref" href="#id21" role="doc-backlink">Aha: the x.sentinels array</a><a class="headerlink" href="#aha-the-x-sentinels-array" title="Link to this heading">¶</a></h3>
<p>Mulder’s original algorithm was hard to understand or to change. The
culprit was the x.mapping array, which mapped indices into arrays of lines
<em>with</em> sentinels to indices into arrays of lines <em>without</em> sentinels.</p>
<p>The new algorithm replaces the x.mapping array with the x.sentinels array.
As a result, diff indices never need to be adjusted and handling diff
opcodes is easy.</p>
<p>For any index i, x.sentinels[i] is the (possibly empty) list of sentinel
lines that precede line a[i]. Computing x.sentinels from old_private_lines
is easy. Crucially, x.a and x.sentinels are <em>parallel arrays</em>. That is,
len(x.a) == len(x.sentinels), so indices into x.a are <em>also</em> indices into
x.sentinels.</p>
</section>
<section id="strategy-proof-of-correctness">
<h3><a class="toc-backref" href="#id22" role="doc-backlink">Strategy &amp; proof of correctness</a><a class="headerlink" href="#strategy-proof-of-correctness" title="Link to this heading">¶</a></h3>
<p>Given the x.sentinels array, the strategy for creating the results is
simple. Given indices ai, aj, bi, bj from an opcode, the algorithm:</p>
<ul class="simple">
<li><p>Writes sentinels from x.sentinels[i], for i in range(ai,aj).</p></li>
<li><p>Writes plain lines from b[i], for i in range(bi,bj).</p></li>
</ul>
<p>This “just works” because the indices cover both a and b.</p>
<ul class="simple">
<li><p>The algorithm writes sentinels exactly once (in order) because each
sentinel appears in x.sentinels[i] for some i in range(len(x.a)).</p></li>
<li><p>The algorithm writes plain lines exactly once (in order) because
each plain line appears in x.b[i] for some i in range(len(x.b)).</p></li>
</ul>
<p>This completes an informal proof of the correctness of the algorithm.</p>
<p>The leading and trailing sentinels lines are easy special cases. This
code, appearing before the main loop, ensures that leading lines are
written first, and only once:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="o">.</span><span class="n">put_sentinels</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">x</span><span class="o">.</span><span class="n">sentinels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
<p>Similarly, this line, at the end of the main loop, writes trailing
sentinels:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">trailing_sentinels</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="summary">
<h3><a class="toc-backref" href="#id23" role="doc-backlink">Summary</a><a class="headerlink" href="#summary" title="Link to this heading">¶</a></h3>
<p>The algorithm creates an updated set of lines <em>with</em> sentinels using the
&#64;clean outline and the updated external file. These new lines then replace
the original &#64;clean with a new &#64;clean tree. The algorithm uses only
difflib. It will work with <em>any</em> kind of text file. No knowledge of any
language is needed.</p>
<p>The algorithm depends on simple, guaranteed, properties of indices in
SequenceMatcher opcodes.</p>
<p>The algorithm steps through x.sentinels and x.b, extending x.results
as it goes.</p>
<p>The algorithm gets all needed data directly from opcode indices into
x.sentinels and x.b. Using opcode indices requires neither reader
classes nor auxiliary indices.</p>
<p>The algorithm is simple enough to be understood at first reading. I’ll
remember its details for the rest of my life.</p>
</section>
</section>
<section id="why-i-like-python">
<h2><a class="toc-backref" href="#id24" role="doc-backlink">Why I like Python</a><a class="headerlink" href="#why-i-like-python" title="Link to this heading">¶</a></h2>
<p>I wrote this soon after discovering Python in 2001. The conclusions are still valid today.</p>
<p>I’ve known for a while that Python was interesting; I attended a Python conference last year and added Python support to Leo. But last week I got that Python is something truly remarkable. I wanted to convert Leo from wxWindows to wxPython, so I began work on c2py, a Python script that would help convert from C++ syntax to Python. While doing so, I had an Aha experience. Python is more than an incremental improvement over Smalltalk or C++ or objective-C; it is “something completely different”. The rest of this post tries to explain this difference.</p>
<section id="clarity">
<h3><a class="toc-backref" href="#id25" role="doc-backlink">Clarity</a><a class="headerlink" href="#clarity" title="Link to this heading">¶</a></h3>
<p>What struck me first as I converted C++ code to Python is how much less blah, blah, blah there is in Python. No braces, no stupid semicolons and most importantly, <em>no declarations</em>. No more pointless distinctions between const, char *, char const *, char * and wxString. No more wondering whether a variable should be signed, unsigned, short or long.</p>
<p>Declarations add clutter, declarations are never obviously right and declarations don’t prevent memory allocation tragedies. Declarations also hinder prototyping. In C++, if I change the type of something I must change all related declarations; this can be a huge and dangerous task. With Python, I can change the type of an object without changing the code at all! It’s no accident that Leo’s new log pane was created first in Python.</p>
<p>Functions returning tuples are a “minor” feature with a huge impact on code clarity. No more passing pointers to data, no more defining (and allocating and deallocating) temporary structs to hold multiple values.</p>
<p>Python can’t check declarations because there aren’t any. However, there is a really nifty tool called <a class="reference external" href="https://pylint.pycqa.org/en/latest/">pylint</a> that does many of the checks typically done by compilers.</p>
</section>
<section id="power">
<h3><a class="toc-backref" href="#id26" role="doc-backlink">Power</a><a class="headerlink" href="#power" title="Link to this heading">¶</a></h3>
<p>Python is much more powerful than C++, not because Python has more features, but because Python needs <em>less</em> features. Some examples:</p>
<ul class="simple">
<li><p>Python does everything that the C++ Standard Template Library (STL) does, without any of the blah, blah, blah needed by STL. No fuss, no muss, no code bloat.</p></li>
<li><p>Python’s slicing mechanism is very powerful and applies to any sequence (string, list or tuple). Python’s string library does more with far less functions because slices replace many functions typically found in other string libraries.</p></li>
<li><p>Writing dict = {} creates a dictionary (hash table). Hash tables can contain anything, including lists and other hash tables.</p></li>
<li><p>Python’s special functions,  __init__, __del__, __repr__, __cmp__, etc. are an elegant way to handle any special need that might arise.</p></li>
</ul>
</section>
<section id="safety">
<h3><a class="toc-backref" href="#id27" role="doc-backlink">Safety</a><a class="headerlink" href="#safety" title="Link to this heading">¶</a></h3>
<p>Before using Python I never fully realized how difficult and dangerous memory allocation is in C++. Try doing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">aList</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">aString</span><span class="p">)</span>
</pre></div>
</div>
<p>in C.  You will write about 20 lines of C code. Any error in this code will create a memory allocation crash or leak.</p>
<p>Python is fundamentally safe. C++ is fundamentally unsafe. When I am using Python I am free from worry and anxiety. When I am using C++ I must be constantly “on guard.” A momentary lapse can create a hard-to-find pointer bug. With Python, almost nothing serious can ever go wrong, so I can work late at night, or after a beer. The Python debugger is always available. If an exception occurs, the debugger/interpreter tells me just what went wrong. I don’t have to plan a debugging strategy! Finally, Python recovers from exceptions, so Leo can keep right on going even after a crash!</p>
</section>
<section id="speed">
<h3><a class="toc-backref" href="#id28" role="doc-backlink">Speed</a><a class="headerlink" href="#speed" title="Link to this heading">¶</a></h3>
<p>Python has almost all the speed of C. Other interpretive environments such as icon and Smalltalk have clarity, power and safety similar to Python. What makes Python unique is its seamless way of making C code look like Python code. Python executes at essentially the speed of C code because most Python modules are written in C. The overhead in calling such modules is negligible. Moreover, if code is too slow, one can always create a C module to do the job.</p>
<p>In fact, Python encourages optimization by moving to higher levels of expression. For example, Leo’s Open command reads an XML file. If this command is too slow I can use Python’s XML parser module. This will speed up Leo while at the same time raising the level of the code.</p>
</section>
<section id="conclusions">
<h3><a class="toc-backref" href="#id29" role="doc-backlink">Conclusions</a><a class="headerlink" href="#conclusions" title="Link to this heading">¶</a></h3>
<p>Little of Python is completely new. What stands out is the superb engineering judgment evident in Python’s design. Python is extremely powerful, yet small, simple and elegant. Python allows me to express my intentions clearly and at the highest possible level.</p>
<p>The only hope of making Leo all it can be is to use the best possible tools. I believe Python will allow me to add, at long last, the new features that Leo should have.</p>
<p>Edward K. Ream, October 25, 2001.  P.S., September, 2005:</p>
<p>Four years of experience have only added to my admiration for Python. Leo could
not possibly be what it is today without Python.</p>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="leo_toc.html">
              <img class="logo" src="_static/LeoLogo.svg" alt="Logo of Leo"/>
            </a></p>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="leo-university.html"
                          title="previous chapter">Leo University</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="toc-more-links.html"
                          title="next chapter">More Leo Links</a></p>
  </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="toc-more-links.html" title="More Leo Links"
             >next</a></li>
        <li class="right" >
          <a href="leo-university.html" title="Leo University"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="leo_toc.html">Leo 6.8.6 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Appendices</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 1997-2025, Edward K. Ream.
      Last updated on August 03, 2025.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>